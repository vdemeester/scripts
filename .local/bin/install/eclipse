#!/usr/bin/env sh

version=$1
shift
package=$1
shift
sr=$1

eclipse="eclipse-${package}-${version}-${sr}"
# TODO Support other OS ?
url_os="linux-gtk-x86_64"
url_start="http://www.eclipse.org/downloads/download.php?file=/technology/epp/downloads/release"
url="${url_start}/${version}/${sr}/${eclipse}-${url_os}.tar.gz&r=1"

echo "Installing eclipse"
echo "Cheking eclipse version ${eclipse}"
output="/tmp/${eclipse}-${url_os}.tar.gz"
response="$(curl --write-out %{http_code} --output ${output} --location $url)"
case $response in
    404 )
        echo "$(basename $0): Version not found (HTTP code ${response})"
        rm $output
        exit 1
        ;;
    * )
        echo "$(basename $0): Unknown problem (HTTP code ${response})"
        ;;
esac

if ! test -d $HOME/.local/lib; then
    echo "$(basename $0): $HOME/.local/lib does not exists, creating it."
    mkdir -p $HOME/.local/lib
fi

echo "Extracting Eclipse $version..."
tar xzf $output -C $HOME/.local/lib/${eclipse}
mv $HOME/.local/lib/${eclipse}/eclipse/* $HOME/.local/lib/${eclipse}/
rm -R $HOME/.local/lib/${eclipse}/eclipse

echo "Linking Eclipse $version..."
if test -L $HOME/.local/lib/eclipse; then
    echo "$(basename $0): An Eclipse installation is already present. Change the linking using local_alternative command (if present)."
else
    ln -s $HOME/.local/lib/${eclipse} $HOME/.local/lib/eclipse
fi

echo "Checking Eclipse bin link..."
if ! test -L $HOME/.local/bin/${eclipse}; then
    ln -s $HOME/.local/lib/${eclipse}/eclipse $HOME/.local/bin/${eclipse}
fi
if ! test -L $HOME/.local/bin/eclipse; then
    ln -s $HOME/.local/lib/eclipse/eclipse $HOME/.local/bin/eclipse
fi

echo "Cleaning downloaded file..."
rm $output
