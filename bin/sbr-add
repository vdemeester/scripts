#!/bin/sh
# Script used to add a package to the sbr archlinux repository (local :))
# The assumption is that the local copy of the repository is in 
# $HOME/var/repos/archlinux and is a git-annex repository
SELF=$(basename $0)
set -e
# Env.
test -z "$ARCH" && ARCH=`uname -m`
test -z "$GIT_REPO_FOLDER" && GIT_REPO_FOLDER="$HOME/var/repos/archlinux/"
test -z "$REPO_FOLDER" && REPO_FOLDER="${GIT_REPO_FOLDER}/${ARCH}"
test -z "$REPO_NAME" && REPO_NAME="sbr"
PKGNAME=${PWD##*/}
# Checks
check-command git $SELF
check-command git-annex $SELF
check-command repo-add $SELF

test -d $GIT_REPO_FOLDER || {
    echo "$SELF: $GIT_REPO_FOLDER does not exists." 1>&2
    exit 1
}
test -d $GIT_REPO_FOLDER/.git || {
    echo "$SELF: $GIT_REPO_FOLDER is not a git repository" 1>&2
    exit 1
}

GIT_COMMAND="git --git-dir=$GIT_REPO_FOLDER/.git --work-tree=$GIT_REPO_FOLDER"
# Unlock stuff
$GIT_COMMAND annex unlock ${ARCH}/${REPO_NAME}.db*
# Add current package to the repo
# FIXME check current PKGBUILD for pkg extension (could be pkg.tar only)
repo-add -s $REPO_FOLDER/${REPO_NAME}.db.tar.gz ${PKGNAME}*.pkg.tar.xz
# Move files (+ signatures)
mv ${PKGNAME}*.pkg.tar* ${REPO_FOLDER}/
# Add file to annex
$GIT_COMMAND annex add .
# Commit :)
$GIT_COMMAND commit -m "Add ${PKGNAME} ($(date +'%Y%m%d'))"
# FIXME Should we run git annex sync ?
