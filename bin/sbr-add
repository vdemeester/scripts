#!/bin/sh
# Script used to add a package to the sbr archlinux repository (local :))
# The assumption is that the local copy of the repository is in 
# $HOME/var/repos/archlinux and is a git-annex repository
SELF=$(basename $0)
set -e
# Env.
test -z "$REPO_FOLDER" && REPO_FOLDER="$HOME/var/repos/archlinux"
test -z "$REPO_NAME" && REPO_NAME="sbr"
PKGNAME=${PWD##*/}
# Checks
check-command git $SELF
check-command git-annex $SELF
check-command repo-add $SELF

test -d $REPO_FOLDER || {
    echo "$SELF: $REPO_FOLDER does not exists." 1>&2
    exit 1
}
test -d $REPO_FOLDER/.git || {
    echo "$SELF: $REPO_FOLDER is not a git repository" 1>&2
    exit 1
}

GIT_COMMAND="git --git-dir=$REPO_FOLDER/.git --work-tree=$REPO_FOLDER"
# Unlock stuff
$GIT_COMMAND annex unlock ${REPO_NAME}.db*
# Add current package to the repo
repo-add -s $REPO_FOLDER/${REPO_NAME}.db.tar.gz ${PKGNAME}*.pkg.tar.xz
# Move files (+ signatures)
mv ${PKGNAME}*.pkg.tar.xz* ${REPO_FOLDER}/
# Add file to annex
$GIT_COMMAND annex add .
# Commit :)
$GIT_COMMAND commit -m "Add ${PKGNAME} ($(date +'%Y%m%d'))"
# FIXME Should we run git annex sync ?

