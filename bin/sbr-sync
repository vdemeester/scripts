#!/bin/sh
# Script used to synchronize the repository with pkg.sbr.io
# Some assumption are made (host, path, ...)
SELF=$(basename $0)
set -e
# Env.
test -z "$REPO_FOLDER" && REPO_FOLDER="$HOME/var/repos/archlinux"
test -z "$REMOTE_NAME" && REMOTE_NAME="pkg.sbr.pm"
test -z "$REMOTE_HOST" && REMOTE_HOST="magni"
test -z "$REMOTE_FOLDER" && REMOTE_FOLDER="/srv/www/pkg.sbr.io/archlinux"
# Checks
check-command git $SELF
check-command git-annex $SELF

test -d $REPO_FOLDER || {
    echo "$SELF: $REPO_FOLDER does not exists." 1>&2
    exit 1
}
test -d $REPO_FOLDER/.git || {
    echo "$SELF: $REPO_FOLDER is not a git repository" 1>&2
    exit 1
}

GIT_COMMAND="git --git-dir=$REPO_FOLDER/.git --work-tree=$REPO_FOLDER"

# Git pull && push master
$GIT_COMMAND pull origin master
$GIT_COMMAND push origin master
# Git annex sync
$GIT_COMMAND annex sync
# Git annex copy
$GIT_COMMAND annex copy . --to $REMOTE_NAME
# Git annex sync
$GIT_COMMAND annex sync
# Force remote update (git annex sync remote)
ssh $REMOTE_HOST "cd $REMOTE_FOLDER && git annex sync && git annex dropunused 1-10000 && git annex sync"

