#!/usr/bin/env sh

version=$1
shift
package=$1
shift
sr=$1

eclipse="eclipse-${package}-${version}-${sr}"
# TODO Support other OS ?
url_os="linux-gtk-x86_64"
url_start="http://www.eclipse.org/downloads/download.php?file=/technology/epp/downloads/release"
url="${url_start}/${version}/${sr}/${eclipse}-${url_os}.tar.gz&r=1"

echo "Installing eclipse"
echo "Cheking eclipse version ${eclipse} from ${url} [Enter to continue]"
read x
output="/tmp/${eclipse}-${url_os}.tar.gz"
response="$(curl -C - --write-out %{http_code} --output ${output} --location $url)"
case $response in
    404 )
        echo "$(basename $0): Version not found (HTTP code ${response})"
        rm $output
        exit 1
        ;;
    * )
        echo "$(basename $0): Unknown problem (HTTP code ${response})"
        ;;
esac

if ! test -d $HOME/lib; then
    echo "$(basename $0): $HOME/lib does not exists, creating it."
    mkdir -p $HOME/lib
fi

echo "Extracting Eclipse $version..."
mkdir -p $HOME/lib/${eclipse}
tar xzf $output -C $HOME/lib/${eclipse} --strip-components=1

echo "Linking Eclipse $version..."
if test -L $HOME/lib/eclipse; then
    echo "$(basename $0): An Eclipse installation is already present. Change the linking using local_alternative command (if present)."
else
    ln -s $HOME/lib/${eclipse} $HOME/lib/eclipse
fi

echo "Checking Eclipse bin link..."
if ! test -L $HOME/bin/${eclipse}; then
    ln -s $HOME/lib/${eclipse}/eclipse $HOME/bin/${eclipse}
fi
if ! test -L $HOME/bin/eclipse; then
    ln -s $HOME/lib/eclipse/eclipse $HOME/bin/eclipse
fi

echo "Cleaning downloaded file..."
rm $output
