#!/bin/bash

#: xkcd downloader, which remains the mouse-hover comment

TMP='/tmp/xkcd.cURL.tmp'
XKCD='http://www.xkcd.com'
DIR="$HOME/pictures/xkcd"   #Anywhere you want to store your xkcd comics. Create this by hand.
LOG='_xkcd.last'                 #This is put inside $DIR.

cd "$DIR" || exit 1

function grab()
{
idx=$1
url="$XKCD/$idx/" ; prev=$((idx-1)) ; next=$((idx+1))
curl -s "$url" -o "$TMP"
image=$(grep '<img src="http://imgs.xkcd.com/comics/' "$TMP" | sed 's|.*img src="\([^"]*\)".*|\1|')
name="$idx.${image/http:\/\/imgs.xkcd.com\/comics\//}"
alt=$(grep '<img src="http://imgs.xkcd.com/comics/' "$TMP" | sed 's|.*" alt="\(.*\)".*|\1|')
aria2c -o "$name" "$image" #or wget
echo '<html>' >> $idx.html
echo '<div align=center>'"$alt"'</div>' >> $idx.html
echo '<div align=left>' >> $idx.html
echo '<li><a href="'"$prev"'.html">< Prev</a></li>' >> $idx.html
echo '</div>' >> $idx.html
echo '<div align=center>' >> $idx.html
grep '<img src="http://imgs.xkcd.com/comics/' "$TMP" | sed 's|http://imgs.xkcd.com/comics/|'$idx'.|' >> $idx.html
echo '</div>' >> $idx.html
echo '<div align=right>' >> $idx.html
echo '<li><a href="'"$next"'.html">Next ></a></li>' >> $idx.html
echo '</div>' >> $idx.html
echo '</html>' >> $idx.html
}

if [ "$1" == '-v' ] ; then
    uzbl file://"$DIR"/${2:-1}.html  #or firefox
    exit
elif [ "$#" != '0' ] ; then
    for i in $@ ; do
        grab $i
    done
else
    [ -f "$LOG" ] && last=$(cat "$LOG") || last='1'
    latest=$(curl -s "$XKCD" | grep 'Permanent link to this comic' |
             sed s'|.*xkcd.com/\(.*\)/<.*|\1|')
    for ((idx=last;idx<=latest;idx++)) ; do
        [ -f $idx.html ] || grab $idx
    done
    echo $((latest+1)) > "$LOG"
    echo "==> Updated $last ~ $latest. Enjoy :)"
fi
